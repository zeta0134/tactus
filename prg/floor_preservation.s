    .include "battlefield.inc"
    .include "far_call.inc"
    .include "floor_preservation.inc"
    .include "rainbow.inc"
    .include "zeropage.inc"

    .segment "LEVEL_RAM_0"

room0_battlefield: .res ::BATTLEFIELD_SIZE
room0_tile_data: .res ::BATTLEFIELD_SIZE
room0_tile_flags: .res ::BATTLEFIELD_SIZE
room0_tile_patterns: .res ::BATTLEFIELD_SIZE
room0_tile_attributes: .res ::BATTLEFIELD_SIZE
room0_tile_detail: .res ::BATTLEFIELD_SIZE

room1_battlefield: .res ::BATTLEFIELD_SIZE
room1_tile_data: .res ::BATTLEFIELD_SIZE
room1_tile_flags: .res ::BATTLEFIELD_SIZE
room1_tile_patterns: .res ::BATTLEFIELD_SIZE
room1_tile_attributes: .res ::BATTLEFIELD_SIZE
room1_tile_detail: .res ::BATTLEFIELD_SIZE

room2_battlefield: .res ::BATTLEFIELD_SIZE
room2_tile_data: .res ::BATTLEFIELD_SIZE
room2_tile_flags: .res ::BATTLEFIELD_SIZE
room2_tile_patterns: .res ::BATTLEFIELD_SIZE
room2_tile_attributes: .res ::BATTLEFIELD_SIZE
room2_tile_detail: .res ::BATTLEFIELD_SIZE

room3_battlefield: .res ::BATTLEFIELD_SIZE
room3_tile_data: .res ::BATTLEFIELD_SIZE
room3_tile_flags: .res ::BATTLEFIELD_SIZE
room3_tile_patterns: .res ::BATTLEFIELD_SIZE
room3_tile_attributes: .res ::BATTLEFIELD_SIZE
room3_tile_detail: .res ::BATTLEFIELD_SIZE

room4_battlefield: .res ::BATTLEFIELD_SIZE
room4_tile_data: .res ::BATTLEFIELD_SIZE
room4_tile_flags: .res ::BATTLEFIELD_SIZE
room4_tile_patterns: .res ::BATTLEFIELD_SIZE
room4_tile_attributes: .res ::BATTLEFIELD_SIZE
room4_tile_detail: .res ::BATTLEFIELD_SIZE

room5_battlefield: .res ::BATTLEFIELD_SIZE
room5_tile_data: .res ::BATTLEFIELD_SIZE
room5_tile_flags: .res ::BATTLEFIELD_SIZE
room5_tile_patterns: .res ::BATTLEFIELD_SIZE
room5_tile_attributes: .res ::BATTLEFIELD_SIZE
room5_tile_detail: .res ::BATTLEFIELD_SIZE

room6_battlefield: .res ::BATTLEFIELD_SIZE
room6_tile_data: .res ::BATTLEFIELD_SIZE
room6_tile_flags: .res ::BATTLEFIELD_SIZE
room6_tile_patterns: .res ::BATTLEFIELD_SIZE
room6_tile_attributes: .res ::BATTLEFIELD_SIZE
room6_tile_detail: .res ::BATTLEFIELD_SIZE

    .segment "LEVEL_RAM_1"

room7_battlefield: .res ::BATTLEFIELD_SIZE
room7_tile_data: .res ::BATTLEFIELD_SIZE
room7_tile_flags: .res ::BATTLEFIELD_SIZE
room7_tile_patterns: .res ::BATTLEFIELD_SIZE
room7_tile_attributes: .res ::BATTLEFIELD_SIZE
room7_tile_detail: .res ::BATTLEFIELD_SIZE

room8_battlefield: .res ::BATTLEFIELD_SIZE
room8_tile_data: .res ::BATTLEFIELD_SIZE
room8_tile_flags: .res ::BATTLEFIELD_SIZE
room8_tile_patterns: .res ::BATTLEFIELD_SIZE
room8_tile_attributes: .res ::BATTLEFIELD_SIZE
room8_tile_detail: .res ::BATTLEFIELD_SIZE

room9_battlefield: .res ::BATTLEFIELD_SIZE
room9_tile_data: .res ::BATTLEFIELD_SIZE
room9_tile_flags: .res ::BATTLEFIELD_SIZE
room9_tile_patterns: .res ::BATTLEFIELD_SIZE
room9_tile_attributes: .res ::BATTLEFIELD_SIZE
room9_tile_detail: .res ::BATTLEFIELD_SIZE

room10_battlefield: .res ::BATTLEFIELD_SIZE
room10_tile_data: .res ::BATTLEFIELD_SIZE
room10_tile_flags: .res ::BATTLEFIELD_SIZE
room10_tile_patterns: .res ::BATTLEFIELD_SIZE
room10_tile_attributes: .res ::BATTLEFIELD_SIZE
room10_tile_detail: .res ::BATTLEFIELD_SIZE

room11_battlefield: .res ::BATTLEFIELD_SIZE
room11_tile_data: .res ::BATTLEFIELD_SIZE
room11_tile_flags: .res ::BATTLEFIELD_SIZE
room11_tile_patterns: .res ::BATTLEFIELD_SIZE
room11_tile_attributes: .res ::BATTLEFIELD_SIZE
room11_tile_detail: .res ::BATTLEFIELD_SIZE

room12_battlefield: .res ::BATTLEFIELD_SIZE
room12_tile_data: .res ::BATTLEFIELD_SIZE
room12_tile_flags: .res ::BATTLEFIELD_SIZE
room12_tile_patterns: .res ::BATTLEFIELD_SIZE
room12_tile_attributes: .res ::BATTLEFIELD_SIZE
room12_tile_detail: .res ::BATTLEFIELD_SIZE

room13_battlefield: .res ::BATTLEFIELD_SIZE
room13_tile_data: .res ::BATTLEFIELD_SIZE
room13_tile_flags: .res ::BATTLEFIELD_SIZE
room13_tile_patterns: .res ::BATTLEFIELD_SIZE
room13_tile_attributes: .res ::BATTLEFIELD_SIZE
room13_tile_detail: .res ::BATTLEFIELD_SIZE

    .segment "LEVEL_RAM_2"

room14_battlefield: .res ::BATTLEFIELD_SIZE
room14_tile_data: .res ::BATTLEFIELD_SIZE
room14_tile_flags: .res ::BATTLEFIELD_SIZE
room14_tile_patterns: .res ::BATTLEFIELD_SIZE
room14_tile_attributes: .res ::BATTLEFIELD_SIZE
room14_tile_detail: .res ::BATTLEFIELD_SIZE

room15_battlefield: .res ::BATTLEFIELD_SIZE
room15_tile_data: .res ::BATTLEFIELD_SIZE
room15_tile_flags: .res ::BATTLEFIELD_SIZE
room15_tile_patterns: .res ::BATTLEFIELD_SIZE
room15_tile_attributes: .res ::BATTLEFIELD_SIZE
room15_tile_detail: .res ::BATTLEFIELD_SIZE

room16_battlefield: .res ::BATTLEFIELD_SIZE
room16_tile_data: .res ::BATTLEFIELD_SIZE
room16_tile_flags: .res ::BATTLEFIELD_SIZE
room16_tile_patterns: .res ::BATTLEFIELD_SIZE
room16_tile_attributes: .res ::BATTLEFIELD_SIZE
room16_tile_detail: .res ::BATTLEFIELD_SIZE

room17_battlefield: .res ::BATTLEFIELD_SIZE
room17_tile_data: .res ::BATTLEFIELD_SIZE
room17_tile_flags: .res ::BATTLEFIELD_SIZE
room17_tile_patterns: .res ::BATTLEFIELD_SIZE
room17_tile_attributes: .res ::BATTLEFIELD_SIZE
room17_tile_detail: .res ::BATTLEFIELD_SIZE

room18_battlefield: .res ::BATTLEFIELD_SIZE
room18_tile_data: .res ::BATTLEFIELD_SIZE
room18_tile_flags: .res ::BATTLEFIELD_SIZE
room18_tile_patterns: .res ::BATTLEFIELD_SIZE
room18_tile_attributes: .res ::BATTLEFIELD_SIZE
room18_tile_detail: .res ::BATTLEFIELD_SIZE

room19_battlefield: .res ::BATTLEFIELD_SIZE
room19_tile_data: .res ::BATTLEFIELD_SIZE
room19_tile_flags: .res ::BATTLEFIELD_SIZE
room19_tile_patterns: .res ::BATTLEFIELD_SIZE
room19_tile_attributes: .res ::BATTLEFIELD_SIZE
room19_tile_detail: .res ::BATTLEFIELD_SIZE

room20_battlefield: .res ::BATTLEFIELD_SIZE
room20_tile_data: .res ::BATTLEFIELD_SIZE
room20_tile_flags: .res ::BATTLEFIELD_SIZE
room20_tile_patterns: .res ::BATTLEFIELD_SIZE
room20_tile_attributes: .res ::BATTLEFIELD_SIZE
room20_tile_detail: .res ::BATTLEFIELD_SIZE

    .segment "LEVEL_RAM_3"

room21_battlefield: .res ::BATTLEFIELD_SIZE
room21_tile_data: .res ::BATTLEFIELD_SIZE
room21_tile_flags: .res ::BATTLEFIELD_SIZE
room21_tile_patterns: .res ::BATTLEFIELD_SIZE
room21_tile_attributes: .res ::BATTLEFIELD_SIZE
room21_tile_detail: .res ::BATTLEFIELD_SIZE

room22_battlefield: .res ::BATTLEFIELD_SIZE
room22_tile_data: .res ::BATTLEFIELD_SIZE
room22_tile_flags: .res ::BATTLEFIELD_SIZE
room22_tile_patterns: .res ::BATTLEFIELD_SIZE
room22_tile_attributes: .res ::BATTLEFIELD_SIZE
room22_tile_detail: .res ::BATTLEFIELD_SIZE

room23_battlefield: .res ::BATTLEFIELD_SIZE
room23_tile_data: .res ::BATTLEFIELD_SIZE
room23_tile_flags: .res ::BATTLEFIELD_SIZE
room23_tile_patterns: .res ::BATTLEFIELD_SIZE
room23_tile_attributes: .res ::BATTLEFIELD_SIZE
room23_tile_detail: .res ::BATTLEFIELD_SIZE

room24_battlefield: .res ::BATTLEFIELD_SIZE
room24_tile_data: .res ::BATTLEFIELD_SIZE
room24_tile_flags: .res ::BATTLEFIELD_SIZE
room24_tile_patterns: .res ::BATTLEFIELD_SIZE
room24_tile_attributes: .res ::BATTLEFIELD_SIZE
room24_tile_detail: .res ::BATTLEFIELD_SIZE

room25_battlefield: .res ::BATTLEFIELD_SIZE
room25_tile_data: .res ::BATTLEFIELD_SIZE
room25_tile_flags: .res ::BATTLEFIELD_SIZE
room25_tile_patterns: .res ::BATTLEFIELD_SIZE
room25_tile_attributes: .res ::BATTLEFIELD_SIZE
room25_tile_detail: .res ::BATTLEFIELD_SIZE

room26_battlefield: .res ::BATTLEFIELD_SIZE
room26_tile_data: .res ::BATTLEFIELD_SIZE
room26_tile_flags: .res ::BATTLEFIELD_SIZE
room26_tile_patterns: .res ::BATTLEFIELD_SIZE
room26_tile_attributes: .res ::BATTLEFIELD_SIZE
room26_tile_detail: .res ::BATTLEFIELD_SIZE

room27_battlefield: .res ::BATTLEFIELD_SIZE
room27_tile_data: .res ::BATTLEFIELD_SIZE
room27_tile_flags: .res ::BATTLEFIELD_SIZE
room27_tile_patterns: .res ::BATTLEFIELD_SIZE
room27_tile_attributes: .res ::BATTLEFIELD_SIZE
room27_tile_detail: .res ::BATTLEFIELD_SIZE

    .segment "LEVEL_RAM_4"

room28_battlefield: .res ::BATTLEFIELD_SIZE
room28_tile_data: .res ::BATTLEFIELD_SIZE
room28_tile_flags: .res ::BATTLEFIELD_SIZE
room28_tile_patterns: .res ::BATTLEFIELD_SIZE
room28_tile_attributes: .res ::BATTLEFIELD_SIZE
room28_tile_detail: .res ::BATTLEFIELD_SIZE

room29_battlefield: .res ::BATTLEFIELD_SIZE
room29_tile_data: .res ::BATTLEFIELD_SIZE
room29_tile_flags: .res ::BATTLEFIELD_SIZE
room29_tile_patterns: .res ::BATTLEFIELD_SIZE
room29_tile_attributes: .res ::BATTLEFIELD_SIZE
room29_tile_detail: .res ::BATTLEFIELD_SIZE

room30_battlefield: .res ::BATTLEFIELD_SIZE
room30_tile_data: .res ::BATTLEFIELD_SIZE
room30_tile_flags: .res ::BATTLEFIELD_SIZE
room30_tile_patterns: .res ::BATTLEFIELD_SIZE
room30_tile_attributes: .res ::BATTLEFIELD_SIZE
room30_tile_detail: .res ::BATTLEFIELD_SIZE

room31_battlefield: .res ::BATTLEFIELD_SIZE
room31_tile_data: .res ::BATTLEFIELD_SIZE
room31_tile_flags: .res ::BATTLEFIELD_SIZE
room31_tile_patterns: .res ::BATTLEFIELD_SIZE
room31_tile_attributes: .res ::BATTLEFIELD_SIZE
room31_tile_detail: .res ::BATTLEFIELD_SIZE

    .segment "CODE_3"

preserved_room_banks:
    .repeat 32, i
    .byte <.bank(.ident(.concat("room", .sprintf("%d", i), "_battlefield")))
    .endrepeat

preserved_room_battlefield_low:
    .repeat 32, i
    .byte <.ident(.concat("room", .sprintf("%d", i), "_battlefield"))
    .endrepeat

preserved_room_battlefield_high:
    .repeat 32, i
    .byte >.ident(.concat("room", .sprintf("%d", i), "_battlefield"))
    .endrepeat

preserved_room_tile_data_low:
    .repeat 32, i
    .byte <.ident(.concat("room", .sprintf("%d", i), "_tile_data"))
    .endrepeat

preserved_room_tile_data_high:
    .repeat 32, i
    .byte >.ident(.concat("room", .sprintf("%d", i), "_tile_data"))
    .endrepeat

preserved_room_tile_flags_low:
    .repeat 32, i
    .byte <.ident(.concat("room", .sprintf("%d", i), "_tile_flags"))
    .endrepeat

preserved_room_tile_flags_high:
    .repeat 32, i
    .byte >.ident(.concat("room", .sprintf("%d", i), "_tile_flags"))
    .endrepeat

preserved_room_tile_patterns_low:
    .repeat 32, i
    .byte <.ident(.concat("room", .sprintf("%d", i), "_tile_patterns"))
    .endrepeat

preserved_room_tile_patterns_high:
    .repeat 32, i
    .byte >.ident(.concat("room", .sprintf("%d", i), "_tile_patterns"))
    .endrepeat

preserved_room_tile_attributes_low:
    .repeat 32, i
    .byte <.ident(.concat("room", .sprintf("%d", i), "_tile_attributes"))
    .endrepeat

preserved_room_tile_attributes_high:
    .repeat 32, i
    .byte >.ident(.concat("room", .sprintf("%d", i), "_tile_attributes"))
    .endrepeat

preserved_room_tile_detail_low:
    .repeat 32, i
    .byte <.ident(.concat("room", .sprintf("%d", i), "_tile_detail"))
    .endrepeat

preserved_room_tile_detail_high:
    .repeat 32, i
    .byte >.ident(.concat("room", .sprintf("%d", i), "_tile_detail"))
    .endrepeat

; arguments: intended room index in X
; (clobbers A)
.proc setup_preservation_pointers
PreservedBattlefieldPtr := R1
PreservedTileDataPtr := R3
PreservedTileFlagsPtr := R5
PreservedTilePatternsPtr := R7
PreservedTileAttributesPtr := R9
PreservedTileDetailPtr := R11
    lda preserved_room_battlefield_low, x
    sta PreservedBattlefieldPtr+0
    lda preserved_room_battlefield_high, x
    sta PreservedBattlefieldPtr+1

    lda preserved_room_tile_data_low, x
    sta PreservedTileDataPtr+0
    lda preserved_room_tile_data_high, x
    sta PreservedTileDataPtr+1

    lda preserved_room_tile_flags_low, x
    sta PreservedTileFlagsPtr+0
    lda preserved_room_tile_flags_high, x
    sta PreservedTileFlagsPtr+1

    lda preserved_room_tile_patterns_low, x
    sta PreservedTilePatternsPtr+0
    lda preserved_room_tile_patterns_high, x
    sta PreservedTilePatternsPtr+1

    lda preserved_room_tile_attributes_low, x
    sta PreservedTileAttributesPtr+0
    lda preserved_room_tile_attributes_high, x
    sta PreservedTileAttributesPtr+1

    lda preserved_room_tile_detail_low, x
    sta PreservedTileDetailPtr+0
    lda preserved_room_tile_detail_high, x
    sta PreservedTileDetailPtr+1

    rts
.endproc

; arguments: current room index in R0
; clobbers: R1-R13
.proc FAR_preserve_room
RoomIndex := R0
RoomBank := R1
PreservedBattlefieldPtr := R2
PreservedTileDataPtr := R4
PreservedTileFlagsPtr := R6
PreservedTilePatternsPtr := R8
PreservedTileAttributesPtr := R10
PreservedTileDetailPtr := R12
    ldx RoomIndex
    jsr setup_preservation_pointers
    ldx RoomIndex
    lda preserved_room_banks, x
    sta RoomBank
    access_ram_bank RoomBank

    ldy #0
loop:
    lda battlefield, y
    sta (PreservedBattlefieldPtr), y
    lda tile_data, y
    sta (PreservedTileDataPtr), y
    lda tile_flags, y
    sta (PreservedTileFlagsPtr), y
    lda tile_patterns, y
    sta (PreservedTilePatternsPtr), y
    lda tile_attributes, y
    sta (PreservedTileAttributesPtr), y
    lda tile_detail, y
    sta (PreservedTileDetailPtr), y
    iny
    cpy #BATTLEFIELD_SIZE
    bne loop

    restore_previous_bank
    rts
.endproc

; arguments: current room index in R0
; clobbers: R1-R13
.proc FAR_restore_preserved_room
RoomIndex := R0
RoomBank := R1
PreservedBattlefieldPtr := R2
PreservedTileDataPtr := R4
PreservedTileFlagsPtr := R6
PreservedTilePatternsPtr := R8
PreservedTileAttributesPtr := R10
PreservedTileDetailPtr := R12
    ldx RoomIndex
    jsr setup_preservation_pointers
    ldx RoomIndex
    lda preserved_room_banks, x
    sta RoomBank
    access_ram_bank RoomBank

    ldy #0
loop:
    lda (PreservedBattlefieldPtr), y
    sta battlefield, y
    lda (PreservedTileDataPtr), y
    sta tile_data, y
    lda (PreservedTileFlagsPtr), y
    sta tile_flags, y
    lda (PreservedTilePatternsPtr), y
    sta tile_patterns, y
    lda (PreservedTileAttributesPtr), y
    sta tile_attributes, y
    lda (PreservedTileDetailPtr), y
    sta tile_detail, y
    iny
    cpy #BATTLEFIELD_SIZE
    bne loop

    restore_previous_bank
    rts
.endproc